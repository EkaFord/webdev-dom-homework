<!DOCTYPE html>
<html>
<head>
  <title>Проект "Комменты"</title>
  <meta charset="utf-8" />
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <div class="container">
    <ul class="comments" id="comments">
      <li class="comment">
        <div class="comment-header">
          <div>Глеб Фокин</div>
          <div>12.02.22 12:18</div>
        </div>
        <div class="comment-body">
          <div class="comment-text">
            Это будет первый комментарий на этой странице
          </div>
        </div>
        <div class="comment-footer">
          <div class="likes">
            <span class="likes-counter">3</span>
            <button class="like-button"></button>
          </div>
        </div>
      </li>
      <li class="comment">
        <div class="comment-header">
          <div>Варвара Н.</div>
          <div>13.02.22 19:22</div>
        </div>
        <div class="comment-body">
          <div class="comment-text">
            Мне нравится как оформлена эта страница! ❤
          </div>
        </div>
        <div class="comment-footer">
          <div class="likes">
            <span class="likes-counter">75</span>
            <button class="like-button -active-like"></button>
          </div>
        </div>
      </li>
    </ul>
    <div class="add-form" id="add-form">
      <input
        type="text"
        id="add-form-name"
        class="add-form-name"
        placeholder="Введите ваше имя"
      />
      <textarea
        type="textarea"
        id="add-form-text"
        class="add-form-text"
        placeholder="Введите ваш комментарий"
        rows="4"
      ></textarea>
      <div class="add-form-row">
        <button class="add-form-button" id="add-form-button">Написать</button>
      </div>
    </div>
  </div>

  <style>
    .error {
      background-color: lightcoral;
    }
    
    .like-button.-active-like {
      background-image: url("data:image/svg+xml,%3Csvg width='22' height='20' viewBox='0 0 22 20' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M15.95 0C14.036 0 12.199 0.882834 11 2.26703C9.801 0.882834 7.964 0 6.05 0C2.662 0 0 2.6267 0 5.99455C0 10.1035 3.74 13.4714 9.405 18.5613L11 20L12.595 18.5613C18.26 13.4714 22 10.1035 22 5.99455C22 2.6267 19.338 0 15.95 0Z' fill='%23BCEC30'/%3E%3C/svg%3E");
    }

    .comment-text {
      white-space: pre-line;
      cursor: pointer;
    }
  </style>

  <script>
    "use strict";

    const addFormElement = document.getElementById("add-form-name");
    const buttonElement = document.getElementById("add-form-button");
    const addFormTextElement = document.getElementById("add-form-text");
    const listElement = document.getElementById("comments");
    const formAddElement = document.getElementById("add-form");
    const addNewComment = document.getElementById("add-form-row");

    let comments = [
      {
        name: "Глеб Фокин",
        date: "12.02.22 12:18",
        text: "Это будет первый комментарий на этой странице",
        likes: 3,
        liked: false,
      },
      {
        name: "Варвара Н.",
        date: "13.02.22 19:22",
        text: "Мне нравится как оформлена эта страница! ❤",
        likes: 75,
        liked: true,
      },
    ];

    const plusZero = (str) => {
      return str < 10 ? `0${str}` : str;
    };

    const now = (currentDate) => {
      let date = plusZero(currentDate.getDate());
      let month = plusZero(currentDate.getMonth() + 1);
      let hours = plusZero(currentDate.getHours());
      let mins = plusZero(currentDate.getMinutes());
      return `${date}.${month}.${currentDate.getFullYear() % 100} ${hours}:${mins}`;
    };

    const fetchPromise = fetch("https://wedev-api.sky.pro/api/v1/ford-ekaterina/comments", {
      method: "GET"
    });

    // подписываемся на успешное завершение запроса с помощью then
    fetchPromise.then((response) => {
      // Запускаем преобразовываем "сырые" данные от API в json формат
      const jsonPromise = response.json();

      // Подписываемся на результат преобразования
      jsonPromise.then((responseData) => {
        const appComments = responseData.comments.map((comment) => {
          return {
            name: comment.author.name,
            date: now(new Date(comment.date)),
            text: comment.text,
            likes: 0,
            activeLike: false,
            isLoading: false,
          };
        });

        comments = appComments;
        renderComents();
      });
    });

    const initEventListeners = () => {
      const likesButton = document.querySelectorAll(".like-button");
      for (const likeButton of likesButton) {
        likeButton.addEventListener("click", (event) => {
          event.stopPropagation();
          const comment = comments[likeButton.dataset.index];
          comment.myLike ? --comment.likes : ++comment.likes;
          comment.myLike = !comment.myLike;
          renderComents();
        });
      }
    };

    const replyToComment = () => {
      const commentsBody = document.querySelectorAll(".comment");
      for (const commentBody of commentsBody) {
        commentBody.addEventListener('click', () => {
          const oldComment = commentBody.dataset.text;
          const oldName = commentBody.dataset.name;
          addFormTextElement.value += `${oldComment}\n${oldName}:\n `;
          document.querySelector(".add-form-text").focus();
        })
      }
    };

    const renderComents = () => {
      const commentsHTML = comments.map((comment, index) => {
        return `<ul class="comments">
        <li class="comment" id="comment" data-text="${comment.text}" data-name="${comment.name}">
          <div class="comment-header">
            <div>${comment.name}</div>
            <div>${comment.date}</div>
          </div>
          <div class="comment-body">
            <div class="comment-text">
            ${comment.text}
            </div>
          </div>
          <div class="comment-footer">
            <div class="likes">
              <span class="likes-counter">${comment.likes}</span>
              <button data-index="${index}" class="${comment.myLike ? 'like-button -active-like' : 'like-button'}"></button>
            </div>
          </div>
          </li>
          </ul>`;
      })
        .join("");
      listElement.innerHTML = commentsHTML;
      initEventListeners();
      replyToComment();
    };

    buttonElement.addEventListener("click", () => {
      addFormElement.classList.remove("error");
      if (addFormElement.value === "") {
        addFormElement.classList.add("error");
        return;
      }
      addFormTextElement.classList.remove("error");
      if (addFormTextElement.value === "") {
        addFormTextElement.classList.add("error");
        return;
      }

      renderComents();
      buttonElement.disabled = true;
      buttonElement.formContent = "Элемент дбавляется ...";
      fetch("https://wedev-api.sky.pro/api/v1/ford-ekaterina/comments", {
        method: "POST",
        body: JSON.stringify({
          name: addFormElement.value,
          text: addFormTextElement.value,
        })
      }).then((response) => {
        response.json().then((responseData) => {
          fetch("https://wedev-api.sky.pro/api/v1/ford-ekaterina/comments", {
            method: "GET"
          }).then((response) => {
            response.json().then((responseData) => {
              const appComments = responseData.comments.map((comment) => {
                return {
                  name: comment.author.name,
                  date: now(new Date(comment.date)),
                  text: comment.text,
                  likes: 0,
                  activeLike: false,
                  isLoading: false,
                };
              });

              comments = appComments;
              renderComents();
              buttonElement.disabled = false;
              buttonElement.formContent = "Написать";
            });
          });
        });
      });

      renderComents();
      addFormElement.value = "";
      addFormTextElement.value = "";
    });

    console.log("It works!");
  </script>
</body>
</html>
